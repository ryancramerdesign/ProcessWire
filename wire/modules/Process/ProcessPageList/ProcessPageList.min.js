$(document).ready(function(){if(config.ProcessPageList){$("#"+config.ProcessPageList.containerID).ProcessPageList(config.ProcessPageList)}});(function(a){a.fn.ProcessPageList=function(b){var c={mode:"",limit:35,rootPageID:0,showRootPage:true,selectedPageID:0,adminPageID:2,trashPageID:7,langID:0,selectAllowUnselect:false,selectShowPageHeader:true,selectShowPath:true,selectStartLabel:"Change",selectCancelLabel:"Cancel",selectSelectLabel:"Select",selectUnselectLabel:"Unselect",moreLabel:"More",trashLabel:"Trash",moveInstructionLabel:"Click and drag to move",selectSelectHref:"#",selectUnselectHref:"#",ajaxURL:config.urls.admin+"page/list/",ajaxMoveURL:config.urls.admin+"page/sort/",openPagination:0,openPageIDs:[],speed:200,useHoverActions:false,hoverActionDelay:250,hoverActionFade:150};a.extend(c,b);return this.each(function(i){var p=a(this);var x;var o=a("<span class='PageListLoading'></span>");var y=0;var d=0;var e=false;function s(){x=a("<div class='PageListRoot'></div>");if(p.is(":input")){c.selectedPageID=p.val();if(!c.selectedPageID.length){c.selectedPageID=0}c.mode="select";p.before(x);v()}else{c.mode="actions";p.append(x);j(c.rootPageID>0?c.rootPageID:1,x,0,true)}if(c.useHoverActions&&!a("body").hasClass("touch-device")){x.addClass("PageListUseHoverActions");k()}}function k(){var B=null;var C=null;var A=null;function z(E){var F=E.find(".PageListActions");if(!F.is(":visible")||E.hasClass("PageListItemOpen")){E.addClass("PageListItemHover");F.css("display","inline").css("opacity",0).animate({opacity:1},c.hoverActionFade)}}function D(E){var F=E.find(".PageListActions");E.removeClass("PageListItemHover");if(F.is(":visible")){F.animate({opacity:0},c.hoverActionFade,function(){F.hide()})}}a(document).on("mouseover",".PageListItem",function(G){if(x.is(".PageListSorting")||x.is(".PageListSortSaving")){return}if(!a(this).children("a:first").is(":hover")){return}A=a(this);if(A.hasClass("PageListItemHover")){return}var E=a(this);if(B){clearTimeout(B)}var F=c.hoverActionDelay;B=setTimeout(function(){if(A.attr("class")==E.attr("class")){if(!A.children("a:first").is(":hover")){return}var H=a(".PageListItemHover");z(A);H.each(function(){D(a(this))})}},F)}).on("mouseout",".PageListItem",function(G){if(x.is(".PageListSorting")||x.is(".PageListSortSaving")){return}var E=a(this);if(E.hasClass("PageListItemOpen")){return}if(!E.hasClass("PageListItemHover")){return}var F=c.hoverActionDelay*0.7;C=setTimeout(function(){if(E.is(":hover")){return}if(E.attr("class")==A.attr("class")){return}D(E)},F)})}function v(){var z=a("<ul></ul>").addClass("PageListActions PageListSelectActions actions");var A=a("<p></p>").addClass("PageListSelectName");if(c.selectShowPageHeader){A.append(o)}var B=a("<a></a>").addClass("PageListSelectActionToggle").attr("href","#").text(c.selectStartLabel).click(function(){if(a(this).text()==c.selectStartLabel){j(c.rootPageID>0?c.rootPageID:1,x,0,true);a(this).text(c.selectCancelLabel)}else{x.children(".PageList").slideUp(c.speed,function(){a(this).remove()});a(this).text(c.selectStartLabel)}return false});z.append(a("<li></li>").append(B));x.append(a("<div></div>").addClass("PageListSelectHeader").append(A).append(z));if(c.selectShowPageHeader){a.getJSON(c.ajaxURL+"?id="+c.selectedPageID+"&render=JSON&start=0&limit=0&lang="+c.langID+"&mode="+c.mode,function(E){var C="";if(c.selectShowPath){C=E.page.path;if(C.substring(-1)=="/"){C=C.substring(0,C.length-1)}C=C.substring(0,C.lastIndexOf("/")+1);C='<span class="detail">'+C+"</span> "}var D=c.selectedPageID>0?C+E.page.label:"";x.children(".PageListSelectHeader").find(".PageListSelectName").html(D)})}}function r(){e=false}function t(z,A,G,K){var I=9;var B=Math.ceil(K/G);d=A>=G?Math.floor(A/G):0;if(d==0){y=0}else{if((d-I+1)>y){y=d-Math.floor(I/2)}else{if(y>0&&d==y){y=d-Math.ceil(I/2)}}}if(y>B-I){y=B-I}if(y<0){y=0}var H=a("<ul></ul>").addClass("PageListPagination").data("paginationInfo",{start:A,limit:G,total:K});var J=function(S){var N=a(this).parents("ul.PageListPagination");var R=N.data("paginationInfo");if(!R){return false}var O=t(z,parseInt(a(this).attr("href"))*R.limit,R.limit,R.total);var Q=a("<li><span class='PageListLoading'></span></li>");N.siblings(".PageList").remove();N.replaceWith(O);O.append(Q);var P=O.siblings().css("opacity",0.5);j(z,O.parent(),a(this).attr("href")*R.limit,false,false,true,function(){Q.remove()});return false};var F=null;var C=null;for(var M=y,D=0;M<B;M++,D++){var E=a("<a></a>").html(M+1).attr("href",M).addClass("ui-state-default");var L=a("<li></li>").addClass("PageListPagination"+D).append(E);if(M==d){L.addClass("PageListPaginationCurrent").find("a").removeClass("ui-state-default").addClass("ui-state-active")}H.append(L);if(!C){C=L.clone().removeClass("PageListPaginationCurrent ui-state-active");C.find("a").removeClass("ui-state-active").addClass("ui-state-default")}if(!F){F=C.clone().removeClass("ui-state-default").html("&hellip;")}if(D>=I&&M<B){$lastItem=C.clone();$lastItem.find("a").text(B).attr("href",B-1);H.append(F.clone()).append($lastItem);break}}if(y>0){$firstItem=C.clone();$firstItem.find("a").text("1").attr("href","0").click(J);H.prepend(F.clone()).prepend($firstItem)}if(d+1<B){$nextBtn=C.clone();$nextBtn.find("a").html("<i class='fa fa-angle-right'></i>").attr("href",d+1);H.append($nextBtn)}if(d>0){$prevBtn=C.clone();$prevBtn.find("a").attr("href",d-1).html("<i class='fa fa-angle-left'></i>");H.prepend($prevBtn)}H.find("a").click(J).hover(function(){a(this).addClass("ui-state-hover")},function(){a(this).removeClass("ui-state-hover")});return H}function j(G,z,F,E,A,B,D){if(A==undefined){A=true}if(B==undefined){B=false}var C=function(L){if(L&&L.error){alert(L.message);o.hide();e=false;return}var H=h(a(L.children));var K=L.start+L.limit;if(L.page.numChildren>K){var J=a("<a></a>").attr("href",K).data("pageId",G).text(c.moreLabel).click(w);H.append(a("<ul></ul>").addClass("PageListActions actions").append(a("<li></li>").addClass("PageListActionMore").append(J)));if(A){H.prepend(t(G,L.start,L.limit,L.page.numChildren))}}H.hide();if(E){var M;M=h(a(L.page));if(c.showRootPage){M.children(".PageListItem").addClass("PageListItemOpen")}else{M.children(".PageListItem").hide().parent(".PageList").addClass("PageListRootHidden")}M.append(H);z.append(M)}else{if(z.is(".PageList")){var I=H.children(".PageListItem, .PageListActions");if(B){z.children(".PageListItem, .PageListActions").replaceWith(I)}else{z.append(I)}}else{z.after(H)}}o.hide();if(B){H.show();r();if(D!=undefined){D()}}else{H.slideDown(c.speed,function(){r();if(D!=undefined){D()}})}if(c.openPagination>1){var J=a(".PageListPagination a[href="+(c.openPagination-1)+"]");if(J.size()>0){J.click();c.openPagination=0}else{a(".PageListPagination9 a").click()}}};if(!B){z.append(o.show())}a.getJSON(c.ajaxURL+"?id="+G+"&render=JSON&start="+F+"&lang="+c.langID+"&open="+c.openPageIDs[0]+"&mode="+c.mode).done(function(I,J,H){C(I)}).fail(function(H,J,I){C({error:1,message:!H.status?c.ajaxNetworkError:c.ajaxUnknownError})})}function h(z){var B=a("<div></div>").addClass("PageList");var A=B;z.each(function(D,C){A.append(g(C))});a("a.PageListPage",A).click(n);a(".PageListActionMove a",A).click(f);a(".PageListActionSelect a",A).click(u);a(".PageListTriggerOpen a.PageListPage",A).click();return B}function g(E){var D=a("<div></div>").data("pageId",E.id).addClass("PageListItem").addClass("PageListTemplate_"+E.template);var C=a("<a></a>").attr("href","#").attr("title",E.path).html(E.label).addClass("PageListPage label");D.addClass("PageListID"+E.id);if(E.status==0){D.addClass("PageListStatusOff disabled")}if(E.status&2048){D.addClass("PageListStatusUnpublished secondary")}if(E.status&1024){D.addClass("PageListStatusHidden secondary")}if(E.status&512){D.addClass("PageListStatusTemp secondary")}if(E.status&16){D.addClass("PageListStatusSystem")}if(E.status&8){D.addClass("PageListStatusSystem")}if(E.status&4){D.addClass("PageListStatusLocked")}if(E.addClass&&E.addClass.length){D.addClass(E.addClass)}if(E.type&&E.type.length>0){if(E.type=="System"){D.addClass("PageListStatusSystem")}}if(E.rm){D.addClass("trashable")}a(c.openPageIDs).each(function(G,F){if(E.id==F){D.addClass("PageListTriggerOpen")}});D.append(C);var A=a("<span>"+(E.numChildren?E.numChildren:"")+"</span>").addClass("PageListNumChildren detail");D.append(A);if(E.note&&E.note.length){D.append(a("<span>"+E.note+"</span>").addClass("PageListNote detail"))}var B=a("<ul></ul>").addClass("PageListActions actions");var z=c.rootPageID==E.id?[]:[{name:c.selectSelectLabel,url:c.selectSelectHref}];if(c.mode=="actions"){z=E.actions}else{if(c.selectAllowUnselect){if(E.id==p.val()){z=[{name:c.selectUnselectLabel,url:c.selectUnselectHref}]}}}a(z).each(function(H,G){if(G.name==c.selectSelectLabel){actionName="Select"}else{if(G.name==c.selectUnselectLabel){actionName="Select"}else{actionName=G.cn}}var F=a("<a></a>").html(G.name).attr("href",G.url);B.append(a("<li></li>").addClass("PageListAction"+actionName).append(F))});D.append(B);return D}function n(z){var C=a(this);var B=C.parent(".PageListItem");var A=B.data("pageId");if(e&&!B.is(".PageListTriggerOpen")){return false}if(x.is(".PageListSorting")||x.is(".PageListSortSaving")){return false}if(B.is(".PageListItemOpen")){B.removeClass("PageListItemOpen").next(".PageList").slideUp(c.speed,function(){a(this).remove()})}else{B.addClass("PageListItemOpen");if(parseInt(B.children(".PageListNumChildren").text())>0){e=true;j(A,B,0,false)}}return false}function w(C){var E=a(this);var A=E.parent("li").parent("ul.PageListActions");var z=A.parent(".PageList");var D=E.data("pageId");var B=parseInt(E.attr("href"));j(D,z,B,false);A.remove();return false}function f(){if(e){return false}var G=a(this);if(a(".PageListItem:visible").length==1){G.css("text-decoration","line-through").addClass("ui-state-disabled");return false}var F=G.parent("li").parent("ul.PageListActions").parent(".PageListItem");if(F.hasClass("PageListItemOpen")){F.children(".PageListPage").click()}x.find(".PageListItemOpen").each(function(){var I=a(this).children(".PageListNumChildren").text();if(parseInt(I)>1&&a(this).next().find(".PageList:visible").size()==0){return}var H=a("<div></div>").addClass("PageListPlaceholder").addClass("PageList");H.append(a("<div></div>").addClass("PageListItem PageListPlaceholderItem").html("&nbsp;"));a(this).after(H)});var E={stop:l,helper:"PageListItemHelper",items:".PageListItem:not(.PageListItemOpen)",placeholder:"PageListSortPlaceholder",start:function(I,H){a(".PageListSortPlaceholder").css("width",H.item.children(".PageListPage").outerWidth()+"px")}};var B=x.children(".PageList").children(".PageList");var z=a("<a href='#'>"+c.selectCancelLabel+"</a>").click(function(){return m(F)});var D=F.children("ul.PageListActions");var C=a("<span class='PageListMoveNote detail'><i class='fa fa-fw fa-sort'></i> "+c.moveInstructionLabel+"<i class='fa fa-fw fa-angle-left'></i></span>");C.append(z);if(F.hasClass("trashable")){var A=a("<a class='PageListActionTrash ui-priority-secondary' href='#'><i class='fa fa-trash-o'></i> "+c.trashLabel+"</i></a>").click(function(){q(F);return false});F.addClass("ui-helper-clearfix");C.append(A)}D.before(C);F.addClass("PageListSortItem");F.parent(".PageList").attr("id","PageListMoveFrom");x.addClass("PageListSorting");B.addClass("PageListSortingList").sortable(E);return false}function m(A){var z=x.find(".PageListSortingList");z.sortable("destroy").removeClass("PageListSortingList");A.removeClass("PageListSortItem").parent(".PageList").removeAttr("id");A.find(".PageListMoveNote").remove();x.find(".PageListPlaceholder").remove();x.removeClass("PageListSorting");return false}function q(C){var z=x.find(".PageListID"+c.trashPageID);if(!z.hasClass("PageListItemOpen")){x.removeClass("PageListSorting");z.children("a").click();x.addClass("PageListSorting")}var A=z.next(".PageList");if(A.length==0){A=a("<div class='PageList'></div>");z.after(A)}A.prepend(C);var B={item:C};l(null,B)}function l(F,K){var H=K.item;var C=H.children(".PageListPage");var A=parseInt(H.data("pageId"));var E=H.parent(".PageList");var I=a("#PageListMoveFrom");var J=E.prev().is(".PageListItem")?E.prev():E.prev().prev();var G=parseInt(J.data("pageId"));var B=H.prev(".PageListItem");if(B.is(".PageListItemOpen")){return false}if(E.is(".PageListPlaceholder")){E.removeClass("PageListPlaceholder").children(".PageListPlaceholderItem").remove()}x.addClass("PageListSortSaving");m(H);H.append(o.show());var D="";E.children(".PageListItem").each(function(){D+=a(this).data("pageId")+","});var z={id:A,parent_id:G,sort:D};z[a("#PageListContainer").attr("data-token-name")]=a("#PageListContainer").attr("data-token-value");var L="unknown";a.post(c.ajaxMoveURL,z,function(O){o.hide();C.fadeOut("fast",function(){a(this).fadeIn("fast");H.removeClass("PageListSortItem");x.removeClass("PageListSorting")});if(O&&O.error){alert(O.message)}if(!E.is("#PageListMoveFrom")){var N=I.prev(".PageListItem");var M=N.children(".PageListNumChildren");var Q=M.text().length>0?parseInt(M.text())-1:0;if(Q==0){Q="";I.remove()}M.text(Q);var P=E.prev(".PageListItem");M=P.children(".PageListNumChildren");Q=M.text().length>0?parseInt(M.text())+1:1;M.text(Q)}I.attr("id","");x.removeClass("PageListSortSaving")},"json");H.trigger("pageMoved");return true}function u(){var F=a(this);var E=F.parent("li").parent("ul.PageListActions").parent(".PageListItem");var D=E.data("pageId");var B=E.children(".PageListPage");var C=B.text();var A=B.attr("title");var z=x.children(".PageListSelectHeader");if(F.text()==c.selectUnselectLabel){D=0;C=""}if(D!=p.val()){p.val(D).change()}if(c.selectShowPageHeader){z.children(".PageListSelectName").text(C)}p.trigger("pageSelected",{id:D,url:A,title:C,a:B});z.find(".PageListSelectActionToggle").click();if(c.selectSelectHref=="#"){return false}return true}s()})}})(jQuery);