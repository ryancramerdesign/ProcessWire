function PageFrontEditInit(f){var k=f(".pw-edit-buttons");var a={};var e=(("ontouchstart" in window)||(navigator.MaxTouchPoints>0)||(navigator.msMaxTouchPoints>0));var i=false;function b(p){i=p;if(i){f("body").addClass("pw-busy")}else{f("body").removeClass("pw-busy")}}function d(p){f("<link/>",{rel:"stylesheet",type:"text/css",href:p}).appendTo("head")}function l(r){var q=r.editor;if(q.checkDirty()){var p=f(q.element.$);if(p.length){p.closest(".pw-edit").addClass("pw-changed")}}}function j(u,r,w,v){if(r.hasClass("pw-editing")||i){return}var p=v.attr("id");var q=r.attr("data-name");r.addClass("pw-editing pw-edited");if(!v.data("prev")){v.data("prev",v.html())}w.hide();v.show();k.show();if(r.hasClass("pw-edit-InputfieldCKEditor")&&typeof CKEDITOR!="undefined"){if(typeof a[p]=="undefined"){var s=CKEDITOR.inline(p,ProcessWire.config["InputfieldCKEditor_"+q]);a[p]=s;s.on("blur",function(t){r.removeClass("pw-editing");l(t)});s.on("change",l)}}setTimeout(function(){v.focus()},250)}function g(r){var w=r.children(".pw-edit-orig");var v=r.children(".pw-edit-copy");var p=r.attr("data-name");v.hide();if(e){w.on("pwdoubletap",function(t){j(t,r,w,v);return false})}w.dblclick(function(t){j(t,r,w,v);return false});if(r.hasClass("pw-edit-InputfieldText")){v.keydown(function(t){if(t.keyCode==13){t.preventDefault()}})}if(w.find("a").length){var q=0,u=null,s=false;w.on("click","a",function(){var t=jQuery(this);if(s){s=false;return true}q++;if(q===1){u=setTimeout(function(){q=0;s=true;t[0].click();return true},700)}else{clearTimeout(u);s=false;q=0;w.trigger("dblclick")}return false});w.on("dblclick","a",function(){return false})}if(!r.hasClass("pw-edit-InputfieldCKEditor")){v.blur(function(){var y=f(this);var x=y.closest(".pw-editing");if(x.length==0){return}if(y.html()!=y.data("prev")){x.addClass("pw-changed")}x.removeClass("pw-editing")})}}function m(){f(".pw-edited").each(function(){var p=f(this);var r=p.children(".pw-edit-copy");var q=p.children(".pw-edit-orig");r.hide().html(r.data("prev"));q.show();r.data("prev",null);p.removeClass("pw-changed pw-edited pw-editing")});k.hide()}function n(){if(f(".pw-changed").length>0){if(confirm(ProcessWire.config.PageFrontEdit.labels.cancelConfirm)){m();k.hide()}else{}}else{m()}return false}function h(){if(i){return}b(true);var y=parseInt(f("#Inputfield_id").val());var p=parseInt(f("#pw-edit-lang").val());var s=f(".pw-edit-save");var t=f(".pw-edit-cancel");var v=f(".pw-edit-saving");var w=f(".pw-edit-saved");var x=f(".pw-changed");var q={action:"PageFrontEditSave",id:y,language:p,fields:{}};var u=f("input._post_token");var r=u.attr("name");var z=u.val();q[r]=z;x.each(function(){var D=f(this);var B=D.attr("data-name");var F=parseInt(D.attr("data-page"));var H=D.children(".pw-edit-orig");var G=D.children(".pw-edit-copy");var C=F+"__"+B;if(D.hasClass("pw-edit-InputfieldCKEditor")){var E=a[G.attr("id")];E.getSelection().reset();E.getSelection().removeAllRanges();q.fields[C]=E.getData()}else{var A=document.createElement("textarea");A.innerHTML=G[0].innerHTML;q.fields[C]=A.value}});s.hide();t.hide();v.show();f.post(ProcessWire.config.PageFrontEdit.pageURL,q,function(C){v.hide();if(C.status>0){x.each(function(){var F=f(this);var D=F.attr("data-name");var G=F.attr("data-page");var I=F.children(".pw-edit-orig");var H=F.children(".pw-edit-copy");var E=G+"__"+D;F.removeClass("pw-editing pw-edited pw-changed");I.html(C.formatted[E]);H.html(C.unformatted[E]);H.data("prev",null);H.hide().trigger("pw-reloaded");I.show().trigger("pw-reloaded")});w.show();setTimeout(function(){k.fadeOut("fast",function(){w.hide();s.show();t.show();b(false)})},1000)}else{b(false);alert(C.error);s.show();t.show();k.hide();f(".pw-editing, .pw-edited").each(function(){var D=f(this);D.removeClass("pw-editing, pw-edited, pw-changed");var F=D.children(".pw-edit-orig");var E=D.children(".pw-edit-copy");E.hide();F.show()})}for(var B in a){var A=a[B];A.destroy()}a={}})}function c(){var p=f(".pw-edit-modal");if(!p.length){return}f(document).on("pw-modal-closed",function(u,r){if(r.abort){return}var t=f(u.target);if(!t.is(".pw-edit-modal")){return}var q=t.attr("id");var s=f("#pw-url").val();s+=(s.indexOf("?")>-1?"&":"?")+"pw_edit_fields="+t.attr("data-fields");b(true);t.load(s+" #"+q,{},function(){var x=f(this);var w=x.children();if(w.length){var v=x.children().html();x.html(v)}x.trigger("pw-reloaded");b(false)})})}function o(){if(e){k.addClass("pw-edit-buttons-touch")}var q=f("#pw-fa-test");var p=q.width();if(p<10){d(ProcessWire.config.PageFrontEdit.files.fa)}q.hide();d(ProcessWire.config.PageFrontEdit.files.css);f("body").addClass("pw-"+ProcessWire.config.PageFrontEdit.adminTheme);f(".pw-edit:not(.pw-edit-modal)").each(function(){g(f(this))});c();if(f(".pw-edit-InputfieldCKEditor").length){jQuery.getScript(ProcessWire.config.PageFrontEdit.files.ckeditor,function(){jQuery.getScript(ProcessWire.config.PageFrontEdit.files.modal,function(){for(var r in ProcessWire.config.InputfieldCKEditor.plugins){var s=ProcessWire.config.InputfieldCKEditor.plugins[r];CKEDITOR.plugins.addExternal(r,s,"")}}).fail(function(t,s,r){alert("failed to load modal.js: "+r)})}).fail(function(t,s,r){alert("failed to load ckeditor.js: "+r)})}else{jQuery.getScript(ProcessWire.config.PageFrontEdit.files.modal).fail(function(t,s,r){alert("failed to load modal.js: "+r)})}f(".pw-edit-cancel").click(n);f(".pw-edit-save").click(function(){f(".pw-editing:not(.pw-edit-InputfieldCKEditor)").blur();setTimeout(function(){h()},250)})}o()}jQuery(document).ready(function(a){PageFrontEditInit(a)});