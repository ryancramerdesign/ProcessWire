(function(){CKEDITOR.plugins.add("pwimage",{requires:"dialog",init:function(c){var d="pwimage";var f="img[alt,id,!src,title,width](align_left,align_center,align_right,hidpi,align-left,align-center,align-right);a[!href];figure{width}(align_left,align_center,align_right,hidpi,align-left,align-center,align-right);figcaption;";var e="img[alt,src]";c.addCommand(d,{allowedContent:f,requiredContent:e,exec:b});c.ui.addButton("PWImage",{label:c.lang.common.image,command:d,hidpi:true,icon:(CKEDITOR.env.hidpi?this.path+"images/hidpi/pwimage.png":this.path+"images/pwimage.png")});c.on("doubleclick",function(g){var h=g.data.element;if((h.is("img"))&&!h.data("cke-realelement")&&!h.isReadOnly()){g.cancel();c.commands.pwimage.exec()}});if(c.addMenuItems){c.addMenuItems({image:{label:c.lang.image.menu,command:"pwimage",group:"image"}})}if(c.contextMenu){c.contextMenu.addListener(function(g,h){if(a(c,g)){return{image:CKEDITOR.TRISTATE_OFF}}})}}});function a(d,c){if(!c){var e=d.getSelection();c=e.getSelectedElement()}if(c&&c.is("img")&&!c.data("cke-realelement")&&!c.isReadOnly()){return c}}function b(h){var o=$("#Inputfield_id").val();var j=o;var A="";var k="";var r=0;var z=0;var x="";var i="";var c=false;var D=h.getSelection();var E=D.getSelectedElement();var y=D.getStartElement();var B=$(y);var g=y.getParent();var q=g.getParent();var m=B.attr("src");var p=null;var C=null;var u=null;var e=g.$.nodeName.toUpperCase();var l=q?q.$.nodeName.toUpperCase():"";D.lock();h.lockSelection();if(l=="FIGURE"){C=$(q.getOuterHtml());u=C.find("figcaption");C.find("img").remove()}else{if(e=="FIGURE"){C=$(g.getOuterHtml());u=C.find("figcaption");C.find("img").remove()}}if(e==="A"){p=$(g.getOuterHtml());p.find("img").remove()}if(m){k=C?C.attr("class"):B.attr("class");c=k&&k.indexOf("hidpi")>-1;r=B.attr("width");z=B.attr("height");x=B.attr("alt");i=e==="A"?g.$.href:"";var w=m.split("/");A=w.pop();w=w.reverse();o=0;for(var v=0;v<w.length;v++){o=parseInt(w[v]);if(o>0){break}}}var s=config.urls.admin+"page/image/";var f="?id="+o+"&edit_page_id="+j+"&modal=1";if(A.length){f+="&file="+A}if(r){f+="&width="+r}if(z){f+="&height="+z}if(k&&k.length){f+="&class="+encodeURIComponent(k)}f+="&hidpi="+(c?"1":"0");if(x&&x.length){f+="&description="+encodeURIComponent(x)}if(u){f+="&caption=1"}if(i&&i.length){f+="&link="+encodeURIComponent(i)}f+=("&winwidth="+($(window).width()-30));var d={title:"<i class='fa fa-fw fa-folder-open'></i> "+config.InputfieldCKEditor.pwimage.selectLabel,open:function(){if($(".cke_maximized").length>0){$(".ui-dialog").css("z-index",9999);$(".ui-widget-overlay").css("z-index",9998)}}};var t=pwModalWindow(s+f,d,"large");t.load(function(){var G=t.contents();if(G.find("#selected_image").size()>0){var n=[{html:"<i class='fa fa-camera'></i> "+config.InputfieldCKEditor.pwimage.insertBtn,click:function(){function M(S){var ac=t.contents();var T=$("#selected_image",ac);var U=T.attr("width");var ad=T.attr("height");var Y=$("#selected_image_description",ac).val();var af=$("#selected_image_caption",ac).is(":checked")?true:false;var ab=$("#selected_image_hidpi",ac).is(":checked")?true:false;var ae=T.removeClass("ui-resizable No Alignment resizable_setup").removeClass("rotate90 rotate180 rotate270 rotate-90 rotate-180 rotate-270").removeClass("flip_vertical flip_horizontal").attr("class");var R=$("#selected_image_link",ac);var Z=R.is(":checked")?R.val():"";var aa=$("<img />").attr("src",S).attr("alt",Y);if(ab){ae+=(ae.length>0?" ":"")+"hidpi"}if(af===false){aa.addClass(ae)}if(U>0){aa.attr("width",U)}if(p){if(Z&&Z.length>0){p.attr("href",Z).attr("data-cke-saved-href",Z)}else{if(R.attr("data-was-checked")==1){p=null}}if(p!==null){p.append(aa);aa=p}}else{if(Z&&Z.length>0){var W=$("<a />").attr("href",Z).append(aa);aa=W}}if(af){var V=$("<figure />");if(ae.length){V.addClass(ae)}if(!u){u=$("<figcaption />");if(Y.length>1){u.append(Y)}else{u.append(config.InputfieldCKEditor.pwimage.captionLabel)}}if(u){V.append(u)}V.prepend(aa);aa=V}h.unlockSelection();D.unlock();if(l==="FIGURE"){D.selectElement(q)}else{if(e==="A"||e=="FIGURE"){D.selectElement(g)}}var X=aa[0].outerHTML;h.insertHtml(X);h.fire("change");t.dialog("close")}var O=t.contents();var H=$("#selected_image",O);t.dialog("disable");t.setTitle("<i class='fa fa-fw fa-spin fa-spinner'></i> "+config.InputfieldCKEditor.pwimage.savingNote);H.removeClass("resized");var I=H.attr("width");if(!I){I=H.width()}var P=H.attr("height");if(!P){P=H.height()}var J=H.attr("src");var Q=$("#page_id",O).val();var N=$("#selected_image_hidpi",O).is(":checked")?1:0;var L=parseInt($("#selected_image_rotate",O).val());J=J.substring(J.lastIndexOf("/")+1);var K=s+"resize?id="+Q+"&file="+J+"&width="+I+"&height="+P+"&hidpi="+N;if(L){K+="&rotate="+L}if(H.hasClass("flip_horizontal")){K+="&flip=h"}else{if(H.hasClass("flip_vertical")){K+="&flip=v"}}$.get(K,function(S){var R=$("<div></div>").html(S);var T=R.find("#selected_image").attr("src");M(T)})}},{html:"<i class='fa fa-folder-open'></i> "+config.InputfieldCKEditor.pwimage.selectBtn,"class":"ui-priority-secondary",click:function(){var I=t.contents();var H=$("#page_id",I).val();t.attr("src",s+"?id="+H+"&modal=1");t.setButtons({})}},{html:"<i class='fa fa-times-circle'></i> "+config.InputfieldCKEditor.pwimage.cancelBtn,"class":"ui-priority-secondary",click:function(){t.dialog("close")}}];t.setButtons(n);t.setTitle("<i class='fa fa-fw fa-picture-o'></i> "+G.find("title").html())}else{var n=[];$("button.pw-modal-button, button[type=submit]:visible",G).each(function(){var I=$(this);var H={html:I.html(),click:function(){I.click()}};n.push(H);if(!I.hasClass("pw-modal-button-visible")){I.hide()}});var F={html:"<i class='fa fa-times-circle'></i> "+config.InputfieldCKEditor.pwimage.cancelBtn,"class":"ui-priority-secondary",click:function(){t.dialog("close")}};n.push(F);t.setButtons(n)}})}})();